#!/bin/bash --login

# usage:
#   ./install [PROJECT_NAME] [GIT_URL] [GIT_COMMIT] [GIT_BRANCH] [CONFIG_DIR]

# This executable file should load minimum environment and start installation of
# the given project. After the script is done, the project should be prepared
# for the testing. This script can be run on the frontend node to save your
# budget hours.


ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )"
NOW=$(date "+%Y-%m-%d_%H-%M-%S")

echo "#############################################"
echo "[$NOW] running installation script with following args:"
echo "$@"
echo "#############################################"




# Example for the HPC charon.nti.tul.cz
# ------------------------------------------------------------------------------
. /etc/profile
module purge
module load metabase
module load python-3.6.2-gcc
module load python36-modules-gcc
module list

set -x

project=$1
git_url=$2
git_commit=$3
git_branch=$4
config_dir=$5


clone_dir=$ROOT/projects/$project
mkdir -p $clone_dir


# get to the correct commit
cd $clone_dir
if [[ -d "$project" ]]; then
  echo "already cloned"
  cd $project
  git fetch
  git reset --hard $git_commit
else
  git clone $git_url $project
  cd $project
  git reset --hard $git_commit
fi



python3 $ROOT/ci-hpc/main.py install \
  --project=$project \
  --commit=$project:$git_commit \
  --branch=$project:$git_branch \
  --config=$(pwd)/$config_dir
exit $?
# ------------------------------------------------------------------------------
